name: QuteFuzz Nightly

on:
  # Run at 2 AM UTC every day
  schedule:
    - cron: '0 2 * * *'

  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      grammars:
        description: 'Grammars to test (space-separated)'
        required: false
        default: 'pytket qiskit'
        type: string

jobs:
  nightly:
    runs-on: ubuntu-24.04
    timeout-minutes: 120  # 2 hours max

    # Grant permissions to post comments
    permissions:
      contents: read      # Read repository contents
      issues: write       # Not needed but often bundled
      pull-requests: write # Not needed but often bundled
      # Note: There's no direct "commit comments" permission,
      # but having write access should work

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Setup Script
        run: |
          chmod +x scripts/setup/setup_env.sh
          ./scripts/setup/setup_env.sh

      - name: Run Nightly Pipeline
        run: |
          # Use workflow inputs if provided, otherwise defaults
          GRAMMARS="${{ github.event.inputs.grammars || 'pytket qiskit' }}"

          uv run scripts/run.py \
            --nightly \
            -- num-tests 10000 \
            --grammars $GRAMMARS

      - name: Upload Interesting Circuits
        if: always()  # Upload even if tests found issues
        uses: actions/upload-artifact@v4
        with:
          name: nightly-results-${{ github.run_number }}
          path: nightly_results/
          retention-days: 90  # Keep for 90 days (max on free tier)
          compression-level: 9  # Maximum compression to save space
