name: QuteFuzz Nightly

on:
  # Run at 2 AM UTC every day
  schedule:
    - cron: '0 2 * * *'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      num_tests:
        description: 'Number of tests per grammar'
        required: false
        default: '100'
        type: string
      grammars:
        description: 'Grammars to test (space-separated)'
        required: false
        default: 'pytket qiskit cirq'
        type: string

jobs:
  nightly:
    runs-on: ubuntu-24.04
    timeout-minutes: 120  # 2 hours max
    
    # Grant permissions to post comments
    permissions:
      contents: read      # Read repository contents
      issues: write       # Not needed but often bundled
      pull-requests: write # Not needed but often bundled
      # Note: There's no direct "commit comments" permission,
      # but having write access should work
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Setup Script
        run: |
          chmod +x scripts/setup/setup_deps.sh
          ./scripts/setup/setup_deps.sh

      - name: Run Nightly Pipeline
        run: |
          # Use workflow inputs if provided, otherwise defaults
          NUM_TESTS="${{ github.event.inputs.num_tests || '100' }}"
          GRAMMARS="${{ github.event.inputs.grammars || 'pytket qiskit cirq' }}"
          
          uv run scripts/ci_pipeline.py \
            --nightly \
            --num-tests "$NUM_TESTS" \
            --grammars $GRAMMARS

      - name: Upload Interesting Circuits
        if: always()  # Upload even if tests found issues
        uses: actions/upload-artifact@v4
        with:
          name: nightly-results-${{ github.run_number }}
          path: nightly_results/
          retention-days: 90  # Keep for 90 days (max on free tier)
          compression-level: 9  # Maximum compression to save space

      - name: Upload Summary Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-report-${{ github.run_number }}
          path: nightly_results/*/report.txt
          retention-days: 90

      - name: Print Summary to Workflow Log
        if: always()
        run: |
          echo "==================================================="
          echo "üîç NIGHTLY RUN SUMMARY"
          echo "==================================================="
          
          # Find the latest report
          LATEST_DIR=$(ls -t nightly_results/ | head -1)
          
          if [ -z "$LATEST_DIR" ]; then
            echo "No nightly results found"
            exit 0
          fi
          
          REPORT_PATH="nightly_results/$LATEST_DIR/report.txt"
          
          if [ ! -f "$REPORT_PATH" ]; then
            echo "No report found at $REPORT_PATH"
            exit 0
          fi
          
          # Print the summary section
          echo ""
          awk '/SUMMARY/,0' "$REPORT_PATH"
          echo ""
          echo "==================================================="
          echo "üì• Download artifacts to view interesting circuits"
          echo "==================================================="
          
          # Check if any interesting circuits were found
          INTERESTING_COUNT=$(grep -oP 'Total interesting:\s*\K\d+' "$REPORT_PATH" || echo "0")
          
          if [ "$INTERESTING_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è  Found $INTERESTING_COUNT interesting circuits!"
            echo "::warning::Nightly testing found $INTERESTING_COUNT interesting circuits. Check artifacts for details."
          else
            echo "‚úÖ No interesting circuits found - all tests passed!"
          fi